# !/bin/bash
# 该脚本在模块编译时由模块的Makefile所调用

# 检查一下所需环境变量是否正常
if [ -z $"MOD_DIR" ]; then
	echo "Bad parameters, MOD_DIR"
	exit 1
fi

if [ -z $"MOD_SRC_INC_DIR" ]; then
	echo "Bad parameters, MOD_SRC_INC_DIR"
	exit 1
fi

if [ -z "$MAJOR_REVISION" ]; then
	echo "Bad parameters, MAJOR_REVISION"
	exit 1
fi

if [ -z "$MINOR_REVISION" ]; then
	echo "Bad parameters, MINOR_REVISION"
	exit 1
fi

if [ -z "$CPPFLAGS" ]; then
	echo "Bad parameters, CPPFLAGS"
	exit 1
fi

if [ -z "$1" ]; then
	echo "No model name"
	exit 1
fi

if [ -z "$2" ]; then
	echo "No header macro defined"
	exit 1
fi

commitDataAndTime=`git log -n 1 --pretty=format:"%cd" --date=iso $MOD_DIR`
commitDateMonth=`echo $commitDataAndTime | cut -d- -f2 | cut -d' ' -f1`
commitDateDay=`echo $commitDataAndTime | cut -d- -f3 | cut -d' ' -f1`
commitDateHour=`echo $commitDataAndTime | cut -d: -f1 | cut -d' ' -f2`
commitDateMin=`echo $commitDataAndTime | cut -d: -f2 | cut -d' ' -f2`

echo "/*****************************************************************" > $MOD_SRC_INC_DIR/revision.h
echo "*******This file is auto generated by genRevisionGit.sh***********" >> $MOD_SRC_INC_DIR/revision.h
echo "*******Any change of it will be overrided when compiling**********" >> $MOD_SRC_INC_DIR/revision.h
echo "*****************************************************************/" >> $MOD_SRC_INC_DIR/revision.h
echo "" >> $MOD_SRC_INC_DIR/revision.h
echo "#ifndef $2" >> $MOD_SRC_INC_DIR/revision.h
echo "#define $2" >> $MOD_SRC_INC_DIR/revision.h
echo "" >> $MOD_SRC_INC_DIR/revision.h
echo "#define MOD_NAME		\"$1\"" >> $MOD_SRC_INC_DIR/revision.h
echo "#define MOD_VERSION 	\
\"$MAJOR_REVISION.$MINOR_REVISION.${commitDateMonth}${commitDateDay}${commitDateHour}${commitDateMin}\"" >> $MOD_SRC_INC_DIR/revision.h
echo "" >> $MOD_SRC_INC_DIR/revision.h
echo "#if 0 // these are the 10 commit logs recently" >> $MOD_SRC_INC_DIR/revision.h
git log -n 10 >> $MOD_SRC_INC_DIR/revision.h
echo "#endif" >> $MOD_SRC_INC_DIR/revision.h
echo "" >> $MOD_SRC_INC_DIR/revision.h
echo "#endif" >> $MOD_SRC_INC_DIR/revision.h
echo "" >> $MOD_SRC_INC_DIR/revision.h

exit 0
